// PLM - Pipeline Management
// Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =========================================================
// ENUMS
// =========================================================

enum TenantStatus {
  active
  inactive
}

enum FormStatus {
  draft
  published
  archived
}

enum PipelineLifecycleStatus {
  draft
  test
  published
  closed
  archived
}

enum PipelineVersionStatus {
  draft
  test
  published
  archived
}

enum StageClassification {
  NOT_STARTED
  ON_GOING
  WAITING
  FINISHED
  CANCELED
}

enum CardFormStatus {
  FILLED
  TO_FILL
  LOCKED
}

enum CardPriority {
  low
  medium
  high
  urgent
}

enum CardStatus {
  active
  closed
  archived
}

enum MoveReason {
  manual
  api
  automation
  external_api
}

enum OutboxStatus {
  pending
  sent
  failed
}

enum EventType {
  PLM_PIPE_CREATED
  PLM_PIPE_PUBLISHED
  PLM_PIPE_CLOSED
  PLM_CARD_CREATED
  PLM_CARD_MOVED
  PLM_CARD_CLOSED
}

enum TriggerExecutionStatus {
  PENDING
  SUCCESS
  FAILURE
}

enum TriggerEventType {
  CARD_MOVEMENT
  FORM_FIELD_CHANGE
}

enum TriggerOperator {
  EQUALS
  NOT_EQUALS
  GREATER_THAN
  LESS_THAN
  GREATER_OR_EQUAL
  LESS_OR_EQUAL
  CONTAINS
  NOT_CONTAINS
  IS_EMPTY
  IS_NOT_EMPTY
}

enum TransitionRuleType {
  FORM_REQUIRED
  COMMENT_REQUIRED
  OWNER_ONLY
}

enum PipelineRole {
  VIEWER      // Can only view cards
  OPERATOR    // Can view, create, and move cards
  SUPERVISOR  // Can view, create, move cards, and edit forms
  ADMIN       // Full control including permission management
}

// =========================================================
// TENANCY
// =========================================================

model Tenant {
  id        String       @id @default(uuid()) @db.Uuid
  name      String       @db.VarChar(255)
  status    TenantStatus @default(active)
  createdAt DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime     @updatedAt @map("updated_at") @db.Timestamptz

  formDefinitions    FormDefinition[]
  pipelines          Pipeline[]
  automationBindings AutomationBinding[]
  cards              Card[]
  outboxEvents       OutboxEvent[]
  integrations       Integration[]
  users              User[]
  plmApiKeys         PlmApiKey[]
  userGroups         UserGroup[]

  @@index([status])
  @@map("tenants")
}

model User {
  id          String    @id @default(uuid()) @db.Uuid
  tahUserId   String    @unique @map("tah_user_id") @db.Uuid
  email       String    @unique @db.VarChar(255)
  name        String?   @db.VarChar(255)
  tenantId    String    @map("tenant_id") @db.Uuid
  orgId       String?   @map("org_id") @db.VarChar(100)
  roles       String[]  @default([])
  lastLoginAt DateTime? @map("last_login_at") @db.Timestamptz
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  tenant           Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  groupMemberships GroupMember[]

  @@index([tenantId])
  @@index([email])
  @@map("users")
}

// =========================================================
// USER GROUPS & PERMISSIONS
// =========================================================

model UserGroup {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  orgId       String   @map("org_id") @db.VarChar(100)
  name        String   @db.VarChar(255)
  description String?  @db.Text
  createdBy   String?  @map("created_by") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  tenant      Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  members     GroupMember[]
  permissions PipelinePermission[]

  @@unique([tenantId, orgId, name], name: "uq_user_group_name")
  @@index([tenantId])
  @@index([orgId])
  @@map("user_groups")
}

model GroupMember {
  id      String   @id @default(uuid()) @db.Uuid
  groupId String   @map("group_id") @db.Uuid
  userId  String   @map("user_id") @db.Uuid
  addedBy String?  @map("added_by") @db.Uuid
  addedAt DateTime @default(now()) @map("added_at") @db.Timestamptz

  group UserGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId], name: "uq_group_member")
  @@index([groupId])
  @@index([userId])
  @@map("group_members")
}

model PipelinePermission {
  id         String       @id @default(uuid()) @db.Uuid
  pipelineId String       @map("pipeline_id") @db.Uuid
  groupId    String       @map("group_id") @db.Uuid
  role       PipelineRole
  createdBy  String?      @map("created_by") @db.Uuid
  createdAt  DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime     @updatedAt @map("updated_at") @db.Timestamptz

  pipeline Pipeline  @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  group    UserGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([pipelineId, groupId], name: "uq_pipeline_permission")
  @@index([pipelineId])
  @@index([groupId])
  @@map("pipeline_permissions")
}

// =========================================================
// FORM DEFINITIONS
// =========================================================

model FormDefinition {
  id         String     @id @default(uuid()) @db.Uuid
  tenantId   String     @map("tenant_id") @db.Uuid
  orgId      String?    @map("org_id") @db.VarChar(100)
  name       String     @db.VarChar(255)
  version    Int        @default(1)
  schemaJson Json       @map("schema_json")
  status     FormStatus @default(draft)
  createdAt  DateTime   @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime   @updatedAt @map("updated_at") @db.Timestamptz

  tenant      Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  attachRules StageFormAttachRule[]
  cardForms   CardForm[]
  triggers    StageTrigger[]

  @@unique([tenantId, orgId, name, version], name: "uq_form_definition_version")
  @@index([tenantId])
  @@index([orgId])
  @@index([status])
  @@map("form_definitions")
}

// =========================================================
// PIPELINES
// =========================================================

model Pipeline {
  id               String                  @id @default(uuid()) @db.Uuid
  tenantId         String                  @map("tenant_id") @db.Uuid
  orgId            String                  @map("org_id") @db.VarChar(100)
  projectId        String?                 @map("project_id") @db.VarChar(100)
  projectName      String?                 @map("project_name") @db.VarChar(255)
  key              String                  @db.VarChar(100)
  name             String                  @db.VarChar(255)
  description      String?                 @db.Text
  lifecycleStatus  PipelineLifecycleStatus @default(draft) @map("lifecycle_status")
  publishedVersion Int?                    @map("published_version")
  createdBy        String?                 @map("created_by") @db.Uuid
  createdAt        DateTime                @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime                @updatedAt @map("updated_at") @db.Timestamptz

  tenant             Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  versions           PipelineVersion[]
  automationBindings AutomationBinding[]
  cards              Card[]
  permissions        PipelinePermission[]

  @@unique([tenantId, orgId, key], name: "uq_pipeline_key_org")
  @@index([tenantId])
  @@index([orgId])
  @@index([projectId])
  @@index([lifecycleStatus])
  @@index([key])
  @@map("pipelines")
}

model PipelineVersion {
  id          String                @id @default(uuid()) @db.Uuid
  pipelineId  String                @map("pipeline_id") @db.Uuid
  version     Int
  status      PipelineVersionStatus @default(draft)
  configHash  String?               @map("config_hash") @db.VarChar(64)
  createdAt   DateTime              @default(now()) @map("created_at") @db.Timestamptz
  publishedAt DateTime?             @map("published_at") @db.Timestamptz

  pipeline    Pipeline          @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  stages      Stage[]
  transitions StageTransition[]

  @@unique([pipelineId, version], name: "uq_pipeline_version")
  @@index([pipelineId])
  @@index([status])
  @@map("pipeline_versions")
}

// =========================================================
// STAGES
// =========================================================

model Stage {
  id                String              @id @default(uuid()) @db.Uuid
  pipelineVersionId String              @map("pipeline_version_id") @db.Uuid
  key               String?             @db.VarChar(100)
  name              String              @db.VarChar(255)
  stageOrder        Int                 @map("stage_order")
  classification    StageClassification
  color             String              @db.VarChar(7)
  isInitial         Boolean             @default(false) @map("is_initial")
  isFinal           Boolean             @default(false) @map("is_final")
  wipLimit          Int?                @map("wip_limit")
  slaHours          Int?                @map("sla_hours")
  active            Boolean             @default(true)
  createdAt         DateTime            @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime            @updatedAt @map("updated_at") @db.Timestamptz

  pipelineVersion        PipelineVersion       @relation(fields: [pipelineVersionId], references: [id], onDelete: Cascade)
  formAttachRules        StageFormAttachRule[]
  transitionsFrom        StageTransition[]     @relation("FromStage")
  transitionsTo          StageTransition[]     @relation("ToStage")
  cards                  Card[]
  cardFormsAttachedAt    CardForm[]
  cardExternalForms      CardExternalForm[]
  moveHistoryFrom        CardMoveHistory[]     @relation("FromStageHistory")
  moveHistoryTo          CardMoveHistory[]     @relation("ToStageHistory")
  automationBindingsFrom AutomationBinding[]   @relation("FilterFromStage")
  automationBindingsTo   AutomationBinding[]   @relation("FilterToStage")
  triggers               StageTrigger[]
  triggersFromStage      StageTrigger[]        @relation("TriggerFromStage")
  conversations          CardConversation[]

  @@index([pipelineVersionId])
  @@index([pipelineVersionId, stageOrder])
  @@map("stages")
}

model StageTransition {
  id                String   @id @default(uuid()) @db.Uuid
  pipelineVersionId String   @map("pipeline_version_id") @db.Uuid
  fromStageId       String   @map("from_stage_id") @db.Uuid
  toStageId         String   @map("to_stage_id") @db.Uuid
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz

  pipelineVersion PipelineVersion @relation(fields: [pipelineVersionId], references: [id], onDelete: Cascade)
  fromStage       Stage           @relation("FromStage", fields: [fromStageId], references: [id], onDelete: Cascade)
  toStage         Stage           @relation("ToStage", fields: [toStageId], references: [id], onDelete: Cascade)
  rules           StageTransitionRule[]

  @@unique([fromStageId, toStageId], name: "uq_stage_transition")
  @@index([pipelineVersionId])
  @@index([fromStageId])
  @@index([toStageId])
  @@map("stage_transitions")
}

model StageTransitionRule {
  id               String             @id @default(uuid()) @db.Uuid
  transitionId     String             @map("transition_id") @db.Uuid
  ruleType         TransitionRuleType @map("rule_type")
  formDefinitionId String?            @map("form_definition_id") @db.Uuid
  enabled          Boolean            @default(true)
  createdAt        DateTime           @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime           @updatedAt @map("updated_at") @db.Timestamptz

  transition StageTransition @relation(fields: [transitionId], references: [id], onDelete: Cascade)

  @@unique([transitionId, ruleType, formDefinitionId], name: "uq_transition_rule")
  @@index([transitionId])
  @@map("stage_transition_rules")
}

model StageFormAttachRule {
  id                  String          @id @default(uuid()) @db.Uuid
  stageId             String          @map("stage_id") @db.Uuid
  formDefinitionId    String?         @map("form_definition_id") @db.Uuid
  externalFormId      String?         @map("external_form_id") @db.VarChar(255)
  externalFormName    String?         @map("external_form_name") @db.VarChar(255)
  externalFormVersion Int?            @map("external_form_version")
  defaultFormStatus   CardFormStatus  @default(TO_FILL) @map("default_form_status")
  lockOnLeaveStage    Boolean         @default(false) @map("lock_on_leave_stage")
  uniqueKeyFieldId    String?         @map("unique_key_field_id") @db.VarChar(255)
  createdAt           DateTime        @default(now()) @map("created_at") @db.Timestamptz

  stage          Stage           @relation(fields: [stageId], references: [id], onDelete: Cascade)
  formDefinition FormDefinition? @relation(fields: [formDefinitionId], references: [id], onDelete: SetNull)

  @@unique([stageId, formDefinitionId], name: "uq_stage_form_attach")
  @@unique([stageId, externalFormId], name: "uq_stage_external_form_attach")
  @@index([stageId])
  @@index([formDefinitionId])
  @@map("stage_form_attach_rules")
}

// =========================================================
// AUTOMATION BINDINGS
// =========================================================

model AutomationBinding {
  id                String    @id @default(uuid()) @db.Uuid
  tenantId          String    @map("tenant_id") @db.Uuid
  orgId             String    @map("org_id") @db.VarChar(100)
  pipelineId        String    @map("pipeline_id") @db.Uuid
  eventType         EventType @map("event_type")
  filterFromStageId String?   @map("filter_from_stage_id") @db.Uuid
  filterToStageId   String?   @map("filter_to_stage_id") @db.Uuid
  automationPlanId  String    @map("automation_plan_id") @db.Uuid
  enabled           Boolean   @default(true)
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pipeline        Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  filterFromStage Stage?   @relation("FilterFromStage", fields: [filterFromStageId], references: [id], onDelete: SetNull)
  filterToStage   Stage?   @relation("FilterToStage", fields: [filterToStageId], references: [id], onDelete: SetNull)

  @@index([pipelineId])
  @@index([eventType])
  @@index([orgId])
  @@map("automation_bindings")
}

// =========================================================
// CARDS
// =========================================================

model Card {
  id              String       @id @default(uuid()) @db.Uuid
  tenantId        String       @map("tenant_id") @db.Uuid
  orgId           String       @map("org_id") @db.VarChar(100)
  pipelineId      String       @map("pipeline_id") @db.Uuid
  pipelineVersion Int          @map("pipeline_version")
  currentStageId  String       @map("current_stage_id") @db.Uuid
  title           String       @db.VarChar(500)
  description     String?      @db.Text
  priority        CardPriority @default(medium)
  status          CardStatus   @default(active)
  uniqueKeyValue  String?      @map("unique_key_value") @db.VarChar(500)
  sessionId       String?      @map("session_id") @db.VarChar(255)
  createdBy       String?      @map("created_by") @db.Uuid
  createdAt       DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime     @updatedAt @map("updated_at") @db.Timestamptz
  closedAt        DateTime?    @map("closed_at") @db.Timestamptz

  tenant            Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pipeline          Pipeline           @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  currentStage      Stage              @relation(fields: [currentStageId], references: [id])
  forms             CardForm[]
  externalForms     CardExternalForm[]
  moveHistory       CardMoveHistory[]
  triggerExecutions TriggerExecution[]
  comments          CardComment[]
  conversations     CardConversation[]

  @@unique([pipelineId, sessionId], name: "uq_card_session")
  @@index([tenantId])
  @@index([orgId])
  @@index([pipelineId])
  @@index([currentStageId])
  @@index([status])
  @@index([priority])
  @@index([sessionId])
  @@index([createdAt(sort: Desc)])
  @@index([pipelineId, status, currentStageId], name: "idx_cards_kanban")
  @@map("cards")
}

model CardForm {
  id                String         @id @default(uuid()) @db.Uuid
  cardId            String         @map("card_id") @db.Uuid
  formDefinitionId  String         @map("form_definition_id") @db.Uuid
  formVersion       Int            @map("form_version")
  status            CardFormStatus @default(TO_FILL)
  data              Json           @default("{}")
  attachedAtStageId String         @map("attached_at_stage_id") @db.Uuid
  attachedAt        DateTime       @default(now()) @map("attached_at") @db.Timestamptz
  updatedAt         DateTime       @updatedAt @map("updated_at") @db.Timestamptz

  card            Card           @relation(fields: [cardId], references: [id], onDelete: Cascade)
  formDefinition  FormDefinition @relation(fields: [formDefinitionId], references: [id])
  attachedAtStage Stage          @relation(fields: [attachedAtStageId], references: [id])

  @@unique([cardId, formDefinitionId, formVersion], name: "uq_card_form")
  @@index([cardId])
  @@index([formDefinitionId])
  @@index([status])
  @@map("card_forms")
}

model CardExternalForm {
  id              String    @id @default(uuid()) @db.Uuid
  cardId          String    @map("card_id") @db.Uuid
  externalFormId  String    @map("external_form_id") @db.VarChar(255)
  externalRowId   String?   @map("external_row_id") @db.VarChar(255)
  stageId         String    @map("stage_id") @db.Uuid
  status          CardFormStatus @default(TO_FILL)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  card  Card  @relation(fields: [cardId], references: [id], onDelete: Cascade)
  stage Stage @relation(fields: [stageId], references: [id])

  @@unique([cardId, externalFormId], name: "uq_card_external_form")
  @@index([cardId])
  @@index([externalFormId])
  @@map("card_external_forms")
}

model CardMoveHistory {
  id          String     @id @default(uuid()) @db.Uuid
  cardId      String     @map("card_id") @db.Uuid
  fromStageId String     @map("from_stage_id") @db.Uuid
  toStageId   String     @map("to_stage_id") @db.Uuid
  movedBy     String?    @map("moved_by") @db.Uuid
  movedAt     DateTime   @default(now()) @map("moved_at") @db.Timestamptz
  reason      MoveReason @default(manual)

  card      Card  @relation(fields: [cardId], references: [id], onDelete: Cascade)
  fromStage Stage @relation("FromStageHistory", fields: [fromStageId], references: [id])
  toStage   Stage @relation("ToStageHistory", fields: [toStageId], references: [id])

  @@index([cardId])
  @@index([fromStageId])
  @@index([toStageId])
  @@index([movedAt(sort: Desc)])
  @@map("card_move_history")
}

model CardComment {
  id        String   @id @default(uuid()) @db.Uuid
  cardId    String   @map("card_id") @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  userName  String   @map("user_name") @db.VarChar(255)
  content   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  card Card @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@index([cardId])
  @@index([createdAt(sort: Desc)])
  @@map("card_comments")
}

// =========================================================
// OUTBOX EVENTS
// =========================================================

model OutboxEvent {
  id         String       @id @default(uuid()) @db.Uuid
  tenantId   String       @map("tenant_id") @db.Uuid
  orgId      String       @map("org_id") @db.VarChar(100)
  eventType  String       @map("event_type") @db.VarChar(50)
  entityType String       @map("entity_type") @db.VarChar(50)
  entityId   String       @map("entity_id") @db.Uuid
  payload    Json
  status     OutboxStatus @default(pending)
  attempts   Int          @default(0)
  createdAt  DateTime     @default(now()) @map("created_at") @db.Timestamptz
  sentAt     DateTime?    @map("sent_at") @db.Timestamptz
  lastError  String?      @map("last_error") @db.Text

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([createdAt])
  @@index([entityType, entityId])
  @@index([orgId])
  @@map("outbox_events")
}

// =========================================================
// INTEGRATIONS
// =========================================================

model Integration {
  id                 String   @id @default(uuid()) @db.Uuid
  tenantId           String   @map("tenant_id") @db.Uuid
  orgId              String   @map("org_id") @db.VarChar(100)
  key                String   @db.VarChar(100)
  name               String   @db.VarChar(255)
  description        String?  @db.Text
  externalApiKeyId   String   @map("external_api_key_id") @db.VarChar(255)
  externalApiKeyName String?  @map("external_api_key_name") @db.VarChar(255)
  httpMethod         String   @default("POST") @map("http_method") @db.VarChar(10)
  endpoint           String?  @db.Text
  defaultPayload     Json?    @map("default_payload")
  enabled            Boolean  @default(true)
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime @updatedAt @map("updated_at") @db.Timestamptz

  tenant   Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  triggers StageTrigger[]

  @@unique([tenantId, orgId, key], name: "uq_integration_key_org")
  @@index([tenantId])
  @@index([orgId])
  @@map("integrations")
}

// =========================================================
// STAGE TRIGGERS
// =========================================================

model StageTrigger {
  id                  String           @id @default(uuid()) @db.Uuid
  stageId             String           @map("stage_id") @db.Uuid
  integrationId       String           @map("integration_id") @db.Uuid
  eventType           TriggerEventType @map("event_type")
  fromStageId         String?          @map("from_stage_id") @db.Uuid
  formDefinitionId    String?          @map("form_definition_id") @db.Uuid
  externalFormId      String?          @map("external_form_id") @db.VarChar(255)
  externalFormName    String?          @map("external_form_name") @db.VarChar(255)
  fieldId             String?          @map("field_id") @db.VarChar(100)
  executionOrder      Int              @default(0) @map("execution_order")
  enabled             Boolean          @default(true)
  createdAt           DateTime         @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime         @updatedAt @map("updated_at") @db.Timestamptz

  stage          Stage                   @relation(fields: [stageId], references: [id], onDelete: Cascade)
  integration    Integration             @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  fromStage      Stage?                  @relation("TriggerFromStage", fields: [fromStageId], references: [id], onDelete: SetNull)
  formDefinition FormDefinition?         @relation(fields: [formDefinitionId], references: [id], onDelete: SetNull)
  conditions     StageTriggerCondition[]
  executions     TriggerExecution[]

  @@index([stageId])
  @@index([integrationId])
  @@index([eventType])
  @@map("stage_triggers")
}

model StageTriggerCondition {
  id        String          @id @default(uuid()) @db.Uuid
  triggerId String          @map("trigger_id") @db.Uuid
  fieldPath String          @map("field_path") @db.VarChar(255)
  operator  TriggerOperator
  value     String          @db.VarChar(500)
  createdAt DateTime        @default(now()) @map("created_at") @db.Timestamptz

  trigger StageTrigger @relation(fields: [triggerId], references: [id], onDelete: Cascade)

  @@index([triggerId])
  @@map("stage_trigger_conditions")
}

model TriggerExecution {
  id              String                 @id @default(uuid()) @db.Uuid
  triggerId       String                 @map("trigger_id") @db.Uuid
  cardId          String                 @map("card_id") @db.Uuid
  status          TriggerExecutionStatus @default(PENDING)
  eventType       TriggerEventType       @map("event_type")
  eventPayload    Json?                  @map("event_payload") @db.JsonB
  responsePayload Json?                  @map("response_payload") @db.JsonB
  errorMessage    String?                @map("error_message") @db.Text
  executedAt      DateTime               @default(now()) @map("executed_at") @db.Timestamptz
  completedAt     DateTime?              @map("completed_at") @db.Timestamptz

  trigger StageTrigger @relation(fields: [triggerId], references: [id], onDelete: Cascade)
  card    Card         @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@index([triggerId])
  @@index([cardId])
  @@index([status])
  @@map("trigger_executions")
}

// =========================================================
// PLM API KEYS (External Integration)
// =========================================================

model PlmApiKey {
  id          String    @id @default(uuid()) @db.Uuid
  tenantId    String    @map("tenant_id") @db.Uuid
  orgId       String    @map("org_id") @db.VarChar(100)
  name        String    @db.VarChar(255)
  key         String    @unique @db.VarChar(64)
  description String?   @db.Text
  permissions String[]  @db.VarChar(50)
  enabled     Boolean   @default(true)
  expiresAt   DateTime? @map("expires_at") @db.Timestamptz
  lastUsedAt  DateTime? @map("last_used_at") @db.Timestamptz
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([orgId])
  @@index([key])
  @@index([enabled])
  @@map("plm_api_keys")
}

// =========================================================
// CONVERSATIONS
// =========================================================

enum ConversationChannel {
  WHATSAPP
  WEBCHAT
  PHONE
  EMAIL
  OTHER
}

enum ParticipantType {
  CLIENT
  AGENT
  OPERATOR
}

enum ConversationStatus {
  ACTIVE
  CLOSED
  ABANDONED
  TRANSFERRED
}

model CardConversation {
  id           String             @id @default(uuid()) @db.Uuid
  tenantId     String             @map("tenant_id") @db.Uuid
  orgId        String             @map("org_id") @db.VarChar(100)
  cardId       String             @map("card_id") @db.Uuid
  stageId      String?            @map("stage_id") @db.Uuid
  externalId   String             @map("external_id") @db.VarChar(255)
  channel      ConversationChannel
  status       ConversationStatus @default(ACTIVE)
  participants Json               @default("[]")
  summary      String?            @db.Text
  metadata     Json?
  startedAt    DateTime           @map("started_at") @db.Timestamptz
  endedAt      DateTime?          @map("ended_at") @db.Timestamptz
  createdAt    DateTime           @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime           @updatedAt @map("updated_at") @db.Timestamptz

  card     Card                  @relation(fields: [cardId], references: [id], onDelete: Cascade)
  stage    Stage?                @relation(fields: [stageId], references: [id])
  messages ConversationMessage[]

  @@unique([tenantId, externalId], name: "uq_conversation_external")
  @@index([cardId])
  @@index([stageId])
  @@map("card_conversations")
}

model ConversationMessage {
  id             String          @id @default(uuid()) @db.Uuid
  conversationId String          @map("conversation_id") @db.Uuid
  senderType     ParticipantType @map("sender_type")
  senderName     String          @map("sender_name") @db.VarChar(255)
  senderId       String?         @map("sender_id") @db.VarChar(255)
  content        String          @db.Text
  contentType    String          @default("text") @map("content_type") @db.VarChar(50)
  mediaUrl       String?         @map("media_url") @db.Text
  sentAt         DateTime        @map("sent_at") @db.Timestamptz
  createdAt      DateTime        @default(now()) @map("created_at") @db.Timestamptz

  conversation CardConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("conversation_messages")
}

// =========================================================
// TENANT SETTINGS (API Configurations)
// =========================================================

model TenantSettings {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @unique @map("tenant_id") @db.Uuid

  // External Forms API
  externalFormsBaseUrl       String? @map("external_forms_base_url") @db.VarChar(500)
  externalFormsListEndpoint  String? @map("external_forms_list_endpoint") @db.VarChar(255)
  externalFormsSchemaEndpoint String? @map("external_forms_schema_endpoint") @db.VarChar(255)
  externalFormsDataEndpoint  String? @map("external_forms_data_endpoint") @db.VarChar(255)
  externalFormsApiKey        String? @map("external_forms_api_key") @db.VarChar(500)
  externalFormsEnabled       Boolean @default(false) @map("external_forms_enabled")

  // External Projects API
  externalProjectsBaseUrl      String? @map("external_projects_base_url") @db.VarChar(500)
  externalProjectsListEndpoint String? @map("external_projects_list_endpoint") @db.VarChar(255)
  externalProjectsApiKey       String? @map("external_projects_api_key") @db.VarChar(500)
  externalProjectsEnabled      Boolean @default(false) @map("external_projects_enabled")

  // API Keys Service
  apiKeysServiceBaseUrl      String? @map("api_keys_service_base_url") @db.VarChar(500)
  apiKeysServiceListEndpoint String? @map("api_keys_service_list_endpoint") @db.VarChar(255)
  apiKeysServiceApiKey       String? @map("api_keys_service_api_key") @db.VarChar(500)
  apiKeysServiceEnabled      Boolean @default(false) @map("api_keys_service_enabled")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  @@map("tenant_settings")
}
